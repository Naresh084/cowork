name: "\u2705 Quality Gates"
run-name: "\u2705 Quality Â· ${{ github.ref_name }}"

on:
  push:
    branches:
      - main
      - develop
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
      - 'hotfix/**'

jobs:
  benchmark-delta-gate:
    name: Benchmark Delta Gate
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm turbo run build --filter='./packages/*'

      - name: Benchmark regression tests
        run: |
          pnpm --filter @cowork/sidecar test -- \
            src/benchmark/runner.regression.test.ts \
            src/benchmark/suites/twin-track-core.test.ts

      - name: Sidecar typecheck
        run: pnpm --filter @cowork/sidecar typecheck

  reliability-regression-gate:
    name: Reliability Regression Gate
    continue-on-error: true
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: pnpm turbo run build --filter='./packages/*'

      - name: Install Playwright Chromium
        run: pnpm --filter @cowork/desktop exec playwright install --with-deps chromium

      - name: Reliability/memory/workflow E2E gate
        run: |
          pnpm --filter @cowork/desktop exec playwright test \
            e2e/onboarding.spec.ts \
            e2e/reliability.spec.ts \
            e2e/memory.spec.ts \
            e2e/branching.spec.ts \
            e2e/workflow.spec.ts \
            e2e/browser-operator.spec.ts \
            --project=chromium \
            --config=playwright.reliability.local.config.ts

      - name: Upload Playwright artifacts (failure only)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-quality-gates-artifacts
          path: |
            apps/desktop/playwright-report
            apps/desktop/test-results
          if-no-files-found: ignore

  security-audit-gate:
    name: Security Audit Gate
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit high/critical vulnerabilities
        run: pnpm audit --audit-level high --prod

  hotfix-release-gate:
    name: Hotfix Release Gate
    if: |
      startsWith(github.ref, 'refs/heads/hotfix/') ||
      (github.event_name == 'pull_request' && startsWith(github.head_ref, 'hotfix/'))
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Assert release gate for hotfix candidate
        run: |
          cd apps/desktop/src-sidecar
          pnpm exec tsx <<'TS'
          import { BenchmarkRunner } from './src/benchmark/runner.ts';
          import { BENCHMARK_SUITES } from './src/benchmark/suites/index.ts';

          const runner = new BenchmarkRunner(BENCHMARK_SUITES);
          const result = await runner.runSuite(`hotfix-${Date.now()}`, 'twin-track-core', 'release');
          const failedDimensions = result.scorecard.dimensions.filter((dimension) => !dimension.passed);

          if (failedDimensions.length > 0) {
            throw new Error(
              `Hotfix blocked: dimension failures -> ${failedDimensions
                .map((dimension) => `${dimension.dimension}=${dimension.score.toFixed(3)}`)
                .join(', ')}`,
            );
          }
          if (result.scorecard.featureChecklistScore < 1) {
            throw new Error('Hotfix blocked: feature checklist score below 1.0.');
          }
          if (result.scorecard.finalScore < 0.9) {
            throw new Error(
              `Hotfix blocked: final score ${result.scorecard.finalScore.toFixed(3)} below 0.900.`,
            );
          }

          console.log(
            JSON.stringify(
              {
                status: 'pass',
                finalScore: result.scorecard.finalScore,
                benchmarkScore: result.scorecard.benchmarkScore,
                featureChecklistScore: result.scorecard.featureChecklistScore,
              },
              null,
              2,
            ),
          );
          TS
