# M2-06 Evidence

## Change Summary

- Added a real memory consolidation engine with:
  - duplicate detection and merge logic,
  - pinned-memory preservation,
  - confidence decay for stale unpinned atoms,
  - redundancy reduction + recall-retention metrics.
- Added DB-backed consolidation run tracking in `memory_consolidation_runs`.
- Added periodic consolidation trigger path (`intervalMinutes`) and runtime-config-driven policy controls.
- Replaced placeholder `memory_consolidate` IPC handler with real consolidation execution + emitted stats.
- Wired periodic consolidation into post-invoke middleware flow so memory depth hardens continuously.

## Files Changed

- apps/desktop/src-sidecar/src/memory/consolidation-service.ts
- apps/desktop/src-sidecar/src/memory/consolidation-service.test.ts
- apps/desktop/src-sidecar/src/memory/types.ts
- apps/desktop/src-sidecar/src/memory/index.ts
- apps/desktop/src-sidecar/src/memory/memory-service.ts
- apps/desktop/src-sidecar/src/middleware/middleware-stack.ts
- apps/desktop/src-sidecar/src/ipc-handler.ts
- apps/desktop/src-sidecar/src/agent-runner.ts
- apps/desktop/src-sidecar/src/types.ts

## Verification Commands

```bash
pnpm --filter @gemini-cowork/sidecar test -- src/memory/consolidation-service.test.ts src/memory/semantic-memory-extractor.test.ts src/benchmark/suites/twin-track-core.test.ts
pnpm --filter @gemini-cowork/sidecar typecheck
pnpm --filter @gemini-cowork/desktop typecheck
cargo check
```

## Verification Output Summary

- Consolidation + memory + benchmark suite tests pass (`10/10` in targeted run).
- Sidecar typecheck passes with new consolidation runtime/config wiring.
- Desktop typecheck and Rust `cargo check` pass.

## Acceptance Mapping

- Plan acceptance criteria: Add periodic consolidation and decay policies with pinning support; reduce redundancy >=35% without recall drop.
- Result: Implemented with metric-asserted consolidation test (`redundancyReduction >= 0.35`, `recallRetention >= 0.99`) and pinned-memory protection checks.

## Residual Risks

- Real-world recall quality must still be validated on production-like memory corpora beyond synthetic fixtures.

## Rollback Path

- Revert consolidation engine, middleware trigger, IPC consolidation path, and associated tests.
