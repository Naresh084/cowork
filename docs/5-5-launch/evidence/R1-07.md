# R1-07 Evidence

## Change Summary

- Added durable persistence for chat runtime pending-work state using Zustand `persist`.
- Persisted state is scoped per session and includes:
  - `pendingPermissions`,
  - `pendingQuestions`,
  - `messageQueue`,
  - `streamStall` metadata (including `runId` for recovery continuity),
  - `activeTurnId`.
- Added safe hydration/merge helpers to restore pending-work snapshots into full runtime defaults without corrupting transient fields.
- Added tests for snapshot build/hydration and persisted-merge restoration behavior.

## Files Changed

- apps/desktop/src/stores/chat-store.ts
- apps/desktop/src/stores/chat-store.test.ts

## Verification Commands

```bash
pnpm --filter @gemini-cowork/desktop test -- src/stores/chat-store.test.ts
pnpm --filter @gemini-cowork/desktop typecheck
pnpm --filter @gemini-cowork/sidecar typecheck
```

## Verification Output Summary

- Chat store tests pass (`18/18`) including durable snapshot + merge restoration checks.
- Desktop and sidecar typecheck pass.

## Acceptance Mapping

- Plan acceptance criteria: Persist message queue and pending permissions to durable store keyed by session/run; reload does not lose pending user work.
- Result: Completed. Pending queue/permissions/questions are persisted and restored per session with run-linked stall metadata.

## Residual Risks

- Full cross-process restart validation should still be covered in E2E reliability suite (`Q10-04`).

## Rollback Path

- Revert chat-store persist integration and durable snapshot helper logic.
