# R1-03 Evidence

## Change Summary

- Added Rust-side retry envelope in sidecar transport command dispatch.
- Injected stable `_idempotencyKey` across retries.
- Added sidecar IPC idempotency cache keyed by `command + _idempotencyKey` to prevent duplicate side effects.
- Added targeted sidecar idempotency tests validating:
  - duplicate success responses are cached,
  - duplicate failures are cached,
  - cache keys are command-scoped.

## Files Changed

- apps/desktop/src-tauri/src/sidecar.rs
- apps/desktop/src-sidecar/src/ipc-handler.ts
- apps/desktop/src-sidecar/src/ipc-handler.idempotency.test.ts

## Verification Commands

```bash
pnpm --filter @gemini-cowork/sidecar test -- src/ipc-handler.idempotency.test.ts
pnpm --filter @gemini-cowork/sidecar typecheck
cargo check
```

## Verification Output Summary

- Sidecar test file passes (`3/3` tests).
- Sidecar TypeScript compile passes.
- Rust backend `cargo check` passes.

## Acceptance Mapping

- Plan acceptance criteria: Command-level retry envelope with idempotency keys; no duplicate execution after retries.
- Result: Implemented with transport retry + idempotency key propagation + dedupe path covered by tests.

## Residual Risks

- Long-duration idempotency retention behavior beyond configured TTL still needs stress/chaos validation.

## Rollback Path

- Revert transport retry loop, IPC idempotency cache logic, and idempotency tests.
