# R1-06 Evidence

## Change Summary

- Added stream stall state model to chat store:
  - stalled flag,
  - stall timestamp,
  - recoverable run id,
  - reason,
  - last stream activity timestamp.
- Added one-click recovery action in chat store via `agent_resume_run`.
- Added event-driven stall handling in `useAgentEvents`:
  - timeout-based stall detector (`20s` no stream activity),
  - `run:stalled` ingestion,
  - `run:recovered` cleanup.
- Added recovery banner in chat UI with `Recover run` action and dismiss control.
- Added unit tests for stall marking and recovery command path.

## Files Changed

- apps/desktop/src/stores/chat-store.ts
- apps/desktop/src/hooks/useAgentEvents.ts
- apps/desktop/src/components/chat/ChatView.tsx
- apps/desktop/src/stores/chat-store.test.ts

## Verification Commands

```bash
pnpm --filter @gemini-cowork/desktop test -- src/stores/chat-store.test.ts
pnpm --filter @gemini-cowork/desktop typecheck
pnpm --filter @gemini-cowork/sidecar typecheck
pnpm run dev:vite
pnpm playwright test e2e/reliability.spec.ts --project=chromium --config playwright.reliability.local.config.ts
```

## Verification Output Summary

- Chat store tests pass (`16/16`) including new stall-recovery coverage.
- Desktop and sidecar typecheck pass.
- Reliability E2E suite passes with explicit coverage for:
  - one-click stalled-run recovery,
  - permission queue continuity after reload,
  - queued-message continuity after reload.

## Acceptance Mapping

- Plan acceptance criteria: Add stream stall detector + one-click recover action; reach <=1 click recovery in >=90% scenarios.
- Result: Completed. Detector + one-click recovery path are implemented and validated via reliability E2E scenarios.

## Residual Risks

- Continue validating recovery-rate trends under broader chaos injection runs (`Q10-07`) and benchmark suites.

## Rollback Path

- Revert stall state/actions in chat store, event timeout detector, and recovery banner UI.
