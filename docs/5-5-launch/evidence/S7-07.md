# S7-07 Evidence

## Change Summary

- Hardened external CLI provider safety checks with stricter trust gating:
  - provider binary path allowlist checks,
  - provider binary basename checks,
  - optional SHA-256 digest allowlist checks (`COWORK_CODEX_SHA256_ALLOWLIST`, `COWORK_CLAUDE_SHA256_ALLOWLIST`).
- Enforced trust gating at run start (`CLI_PROVIDER_BLOCKED`) when provider binary fails trust policy.
- Surfaced trust state/reason/hash in Runtime settings UI and disabled tool enable toggles when trust is blocked.

## Files Changed

- `/Users/naresh/Work/Personal/cowork/apps/desktop/src-sidecar/src/external-cli/types.ts`
- `/Users/naresh/Work/Personal/cowork/apps/desktop/src-sidecar/src/external-cli/discovery-service.ts`
- `/Users/naresh/Work/Personal/cowork/apps/desktop/src-sidecar/src/external-cli/run-manager.ts`
- `/Users/naresh/Work/Personal/cowork/apps/desktop/src-sidecar/src/external-cli/errors.ts`
- `/Users/naresh/Work/Personal/cowork/apps/desktop/src-sidecar/src/external-cli/run-manager.test.ts`
- `/Users/naresh/Work/Personal/cowork/apps/desktop/src/components/settings/RuntimeSettings.tsx`

## Verification Commands

```bash
pnpm --filter @cowork/sidecar exec vitest run --config vitest.config.ts src/external-cli/run-manager.test.ts src/tools/external-cli-tools.test.ts
pnpm --filter @cowork/sidecar typecheck
pnpm --filter @cowork/desktop typecheck
```

## Verification Output Summary

- External CLI tests passed, including new run-manager trust-block scenario.
- Sidecar typecheck passed after adding new provider-blocked error code and trust fields.
- Desktop typecheck passed with runtime settings trust rendering updates.

## Acceptance Mapping

- Plan acceptance criteria: external CLI abuse vectors reduced via stricter allowlist/signature checks.
- Current result: external CLI execution now requires trusted binary policy checks and is blocked when trust fails.

## Residual Risks

- Digest allowlist enforcement is optional (env-driven). In environments without configured digest allowlists, trust relies on path+basename policy.

## Rollback Path

- Remove trust gating from discovery/run-manager and revert runtime settings trust-state UI rendering.
