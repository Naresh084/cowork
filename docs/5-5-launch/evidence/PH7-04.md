# PH7-04 Evidence

## Change Summary

- Closed month-7 policy/permission resilience E2E gap with deterministic permission-state assertions in desktop reliability tests.
- Added stable permission persistence/reload checks using seeded runtime snapshots and local persisted state verification.
- Added explicit permission decision command validation for:
  - batch denial across queued approvals,
  - single-request `allow_once` response path.
- Fixed supporting runtime issues uncovered during E2E closure:
  - hydrate runtime snapshots from `agent_get_session_chunk` in chat-store message load path,
  - guard invalid/missing permission `createdAt` in permission timeout logic to prevent accidental immediate auto-deny.

## Files Changed

- apps/desktop/e2e/reliability.spec.ts
- apps/desktop/src/stores/chat-store.ts
- apps/desktop/src/components/dialogs/PermissionDialog.tsx
- apps/desktop/playwright.reliability.local.config.ts

## Verification Commands

```bash
pnpm --filter @cowork/desktop exec playwright test e2e/reliability.spec.ts --project=chromium --config=playwright.reliability.local.config.ts
pnpm --filter @cowork/desktop typecheck
```

## Verification Output Summary

- Reliability suite result: `5 passed (6.0s)` in Chromium.
- Desktop typecheck result: pass (`tsc --noEmit`).

## Acceptance Mapping

- Plan acceptance criteria: Month-7 `PH7-04` E2E policy/permission resilience tests completed.
- Result: Completed. Permission-state durability and deterministic decision command paths are validated in desktop E2E.

## Residual Risks

- E2E currently runs in Chromium only for this local reliability profile; additional browser projects remain optional hardening.
- Full chaos policy/permission permutations remain part of broader quality/chaos scope (`Q10-07`).
