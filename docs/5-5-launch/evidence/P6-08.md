# P6-08 Evidence

## Change Summary

- Added strict idempotency markers to sandbox command executor for mutating/retry-sensitive commands.
- Added `ExecutionOptions.idempotencyKey` and `ExecutionOptions.idempotencyStrategy` (`return_cached` | `reject`).
- Added replay protection behavior:
  - return cached result without re-execution for duplicate retry markers,
  - optional hard-reject mode for duplicate retries.
- Added bounded in-memory idempotency result cache with deterministic marker composition (`cwd + normalized command + key`).

## Files Changed

- packages/sandbox/src/types.ts
- packages/sandbox/src/executor.ts

## Verification Commands

```bash
pnpm --filter @gemini-cowork/sandbox typecheck
pnpm --filter @gemini-cowork/sandbox test
```

## Verification Output Summary

- Sandbox typecheck: pass (`tsc --noEmit`).
- Sandbox tests: pass (`7 passed`), including executor idempotency replay/reject tests.

## Acceptance Mapping

- Plan acceptance criteria: `P6-08` idempotency markers prevent duplicate destructive effects on retries.
- Result: Completed. Duplicate mutating commands with identical idempotency markers are prevented from re-executing.

## Residual Risks

- Idempotency cache is process-memory scoped; cross-process persistence would require shared durable marker storage.
